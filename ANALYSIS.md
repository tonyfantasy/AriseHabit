# Анализ структуры, тесты и рекомендации

## 1. Структура проекта

```
habit app/
├── index.html      # Единая страница: экран создания персонажа + основное приложение + модалка квеста
├── core.js         # Чистая логика (уровни, XP, даты, getDayStats) — без DOM и state
├── app.js          # Состояние, хранилище, рендер, обработчики (~1400 строк)
├── styles.css      # Глобальные переменные, компоненты, тёмная тема (~1250 строк)
├── tests/
│   └── core.test.js  # Unit-тесты для core.js
├── README.md
└── .nojekyll
```

### 1.1 Поток данных

- **Хранилище:** `localStorage` — 4 ключа: данные привычек и выполнений, персонаж, ментальный чат, настройки уведомлений, слоты wellness.
- **Состояние в памяти:** `state = { habits, completions, notificationsEnabled, mental: { step, mood, factor, messages }, character }`. При загрузке страницы вызываются `loadState()`, `loadCharacter()`, `loadMentalState()`.
- **Обновление UI:** после изменения данных вызывается `saveState()` или `saveMentalState()` / `saveCharacter()`, внутри — несколько `render*()` и `updateChart()`. Нет единого «store» — рендер размазан по местам сохранения.

### 1.2 Модули по назначению (app.js)

| Зона | Функции |
|------|--------|
| Константы и state | XP_LEVELS, ACHIEVEMENTS_LIST, MENTAL_*, WELLNESS_*, state |
| Привычки и выполнения | getCompletions, setCompletions, getDayStats, saveState, loadState, normalizeHabit |
| Персонаж и геймификация | getLevelFromXp, xpForNextLevel, updateCharacterXp, updateStreak, checkAchievements, getPixelAvatarSvg |
| Календарь и даты | todayKey, getCalendarDays, formatDateLong, last7Days, dayLabel |
| График | updateChart (Chart.js), цвета и datasets |
| Рендер | renderHabits, renderDayResults, renderCalendar, renderCharacterHeader, renderAchievements, renderMentalHealth |
| Ментальное здоровье | addMentalMessage, showTypingThenReply, getMentalAdvice, onMentalChoice, guiding questions |
| Уведомления | startNotificationChecks, wellness-слоты, habit reminders |
| Инициализация | init(), привязка событий, первый показ экрана |

---

## 2. Тесты

### 2.1 Что покрыто

- **core.js** — чистая логика:
  - **Уровни и XP:** `getLevelFromXp`, `xpForNextLevel`, `xpAtLevelStart` (границы 0, 100, 250, 4000 и т.д.).
  - **Даты:** формат `todayKey` (YYYY-MM-DD), работа с переданной датой.
  - **getDayStats:** пустой список привычек, 0%, 100%, средний процент и XP при нескольких привычках.
  - **getCompletionsFor:** отсутствие привычки/даты, возврат счётчика.
  - **dailySeed / getTodaysVariation:** детерминированность по dateKey, возврат одного из вариантов.

### 2.2 Запуск тестов

Требуется **Node.js** (v14+).

```bash
cd "habit app"
node tests/core.test.js
```

Ожидаемый вывод: список `✓` по каждому тесту и итог «Passed: …».

### 2.3 Рекомендации по тестам

- Добавить тесты на **граничные значения** XP (ровно на границе уровня, больше 4000).
- Покрыть **сброс серии** (логика `updateStreak` при смене дня) через вызовы с подставленным `state.character`.
- Вынести проверки достижений (какие условия дают `first_steps`, `full_day` и т.д.) в отдельные тесты с моком `state`.

---

## 3. Оптимизация

### 3.1 Производительность

- **График:** Chart.js создаётся заново при каждом `updateChart()`; при частых обновлениях лучше вызывать `chart.update()` с новыми data вместо `chart.destroy()` + `new Chart()`.
- **Рендер списка привычек:** при каждом `saveState()` пересобирается весь `habitsList` innerHTML. При большом числе привычек можно обновлять только изменённую строку (data-атрибуты + точечное обновление узла).
- **Календарь:** перерисовывается целиком; при 28 днях приемлемо, при масштабировании — рассмотреть виртуализацию или кэш HTML по датам.
- **Ментальный чат:** при добавлении сообщения перерисовывается весь чат; можно добавлять только новый узел и скроллить вниз.

### 3.2 Код

- **Разбить app.js на модули:** например `storage.js`, `character.js`, `mental.js`, `notifications.js`, рендеры в `views/` или по секциям. Загрузка через несколько `<script>` или сборка (esbuild/vite) для одного бандла.
- **Один источник правды для даты:** везде использовать `todayKey()` или `HabitCore.todayKey()`, избегать ручного `new Date()` для «сегодня».
- **Дебаунс/троттлинг:** при частых кликах по квесту (счётчик вверх/вниз) можно ограничить частоту вызовов `saveState()`.
- **localStorage:** при большом объёме `completions` сериализация может тормозить; рассмотреть ограничение хранимых дат (например, последние 90 дней) или сжатие.

### 3.3 Размер и загрузка

- Шрифты (Google Fonts) — два семейства; при желании ускорить загрузку — подмножество или `font-display: swap`.
- Chart.js подключается с CDN; при офлайне не сработает — при необходимости заложить локальную копию или fallback без графика.

---

## 4. Пользовательский опыт (UX)

### 4.1 Первый запуск и онбординг

- После «Начать приключение» пользователь сразу попадает на главный экран с дефолтными квестами. Рекомендация: короткий онбординг (1–2 экрана) — «Отмечайте выполнение квестов», «Смотрите прогресс и уровень», «Раздел ментального здоровья — для поддержки».
- Явно показать, что данные хранятся только в этом устройстве/браузере (предупреждение при первом сохранении или в разделе «О приложении»).

### 4.2 Обратная связь

- **Сохранение:** при `saveState()` нет индикации «Сохранено»; для мобильных или медленного localStorage можно показывать краткий тост «Сохранено» или иконку галочки.
- **Достижения:** при разблокировке достижения показывать всплывающее уведомление (тост или модалка) с названием и иконкой, а не только обновлять сетку.
- **Серия (streak):** при обрыве серии можно показывать короткое сообщение: «Серия прервана. Начните новую сегодня».

### 4.3 Доступность (a11y)

- У кнопок и интерактивных элементов есть подписи или `aria-label`; проверить модалку (фокус в ловушке, закрытие по Escape уже есть через overlay).
- График: `aria-label="График привычек"` задан; для скринридеров можно добавить краткий текстовый итог (например, «За неделю в среднем 70%»).
- Чат ментального здоровья: индикатор «печатает» с `aria-live="polite"` — хорошо; убедиться, что новые сообщения объявляются (например, через `aria-live` на контейнере чата).
- Контраст текста и кнопок по WCAG проверить (особенно `--text-muted` на тёмном фоне).

### 4.4 Мобильные и жесты

- Кнопки и зоны нажатия достаточно большие; на маленьких экранах проверить блок календаря и квестов (удобно ли тыкать по ячейкам и точкам).
- При желании: свайп по секциям (календарь, график, квесты) или табы для переключения блоков на мобильном.

### 4.5 Ментальное здоровье и уведомления

- В настройках или при первом включении уведомлений можно спросить: «Разрешить напоминания от советника (утро/день/вечер)?» и сохранять отдельный флаг, чтобы не смешивать с напоминаниями по квестам.
- После перехода по уведомлению «Советник» — открывать приложение с прокруткой к секции «Ментальное здоровье» или сразу раскрывать чат (например, через hash `#mental` и скролл к `#mentalSection`).

### 4.6 Отмена и откат

- Случайное снятие отметки с квеста можно отменить: кнопка «Отменить» в течение нескольких секунд или повторный клик по той же точке возвращает предыдущее значение. Сейчас отмена только повторным кликом (снять и поставить снова), явной «Undo» нет.

---

## 5. Краткий чек-лист

| Область | Действие |
|--------|----------|
| Тесты | Запускать `node tests/core.test.js` при изменениях в core.js |
| Производительность | Заменить destroy+new Chart на update(); точечный рендер привычек при росте списка |
| Код | Разбить app.js на модули; ограничить объём данных в localStorage |
| UX | Онбординг, тост «Сохранено», уведомление о новом достижении, сообщение об обрыве серии |
| a11y | Проверить контраст, фокус в модалке, описание графика для скринридеров |
| Мобильный | Проверить размеры тапов; опционально — открытие секции ментального здоровья по клику на wellness-уведомление |
